<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Biplanes</title>
    <style>
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="960" height="640"></canvas>
<div id="debugControls">
        <label>G force</label><input type="number" id="gForce"><br>
        <label>Wing force</label><input type="number" id="wForce"><br>
        <label>Engine force</label><input type="number" id="eForce"><br>
        <label>Mass</label><input type="number" id="mass"><br>
        <label>Max speed</label><input type="number" id="maxSpeed"><br>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");

    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);

    function keyDownHandler(e) {
        if(e.key == "Right" || e.key == "ArrowRight") {
            rightPressed = true;
        }
        else if(e.key == "Left" || e.key == "ArrowLeft") {
            leftPressed = true;
        }
    }

    function shoot() {
        bullets.push(createBullet(plane.x + plane.width / 2, plane.y + plane.height / 2, plane.rotation));
    }

    function keyUpHandler(e) {
        if (e.key == "Right" || e.key == "ArrowRight") {
            rightPressed = false;
        }
        else if (e.key == "Left" || e.key == "ArrowLeft") {
            leftPressed = false;
        }
        else if (e.key == " ") {
            shoot();
        }
    }

    var rightPressed = false;
    var leftPressed = false;

    var eForce = 0.03;
    var g = [0, eForce * 2];
    var maxSpeed = 2;
    var wForce = [0, -0.03];
    var m = 1;

    var plane = {
        x: 0,
        y: 40,
        width: 40,
        height: 30,
        color: "#0000FF",
        rotation: 0,
        speed: [2, 0],
        image: null,
    }

    var bullets = []

    function createBullet(x, y, rotation) {
        return {
            x: x,
            y: y,
            radius: 10,
            rotation: rotation,
            speed: 5,
        }
    }

	function drawPlane() {
        ctx.save();
        ctx.beginPath();
        ctx.translate(plane.x + plane.width / 2, plane.y + plane.height / 2);
        ctx.rotate(plane.rotation * Math.PI / 180);
        var centerX
        ctx.rect(-plane.width / 2, -plane.height / 2, plane.width, plane.height);
        ctx.fillStyle = plane.color;
        ctx.fill();
        ctx.closePath();
        if (plane.image !== null) {
            ctx.drawImage(planeImage, -24, -16, 48, 32);
        }
        ctx.restore();
    }

    function drawBullets() {
        bullets.forEach(b => {
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2);
            ctx.fillStyle = "#FF0000";
            ctx.fill();
            ctx.closePath();
        })
    }

    function advancePlane() {
        //gForce = g * Math.sin(plane.rotation * Math.PI / 180);
        sin = Math.sin(plane.rotation * Math.PI / 180);
        cos = Math.cos(plane.rotation * Math.PI / 180);
        // compute forces
        eForceVec = [eForce * cos, eForce * sin];
        speedProjection = scalarMult(plane.speed, [cos, sin]) / scalarMult([cos, sin], [cos, sin]);
        speedProjection = Math.max(speedProjection, 0);
        wForceComp = cos * wForce[1] * speedProjection / maxSpeed;
        gForceComp = g[1] * Math.pow(Math.abs(sin), 6);
        force = [eForceVec[0], eForceVec[1] + gForceComp];
        // compute acceleration
        acc = [force[0] / m, force[1] / m];
        // compute speed
        plane.speed[0] = plane.speed[0] + force[0];
        plane.speed[1] = plane.speed[1] + force[1];
        // limit speed
        speed = vecLength(plane.speed);
        plane.speed[0] = plane.speed[0] * maxSpeed / speed;
        plane.speed[1] = plane.speed[1] * maxSpeed / speed;
        // apply speed
        plane.x = (canvas.width + plane.x + plane.speed[0]) % canvas.width;
        plane.y = (canvas.height + plane.y + plane.speed[1]) % canvas.height;
    }

    function scalarMult(v1, v2) {
        return v1[0] * v2[0] + v1[1] * v2[1];
    }

    function vecLength(v) {
        return Math.sqrt(v[0]*v[0] + v[1]*v[1]);
    }

    function advanceBullets() {
        bullets.forEach(b => {
            sin = Math.sin(b.rotation * Math.PI / 180);
            cos = Math.cos(b.rotation * Math.PI / 180);
            b.y = (b.y + b.speed * sin);
            b.x = (b.x + b.speed * cos);
        });
    }

    function checkCollision() {
        for (ball of bullets) {
            if ((ball.x + ball.r > plane.x) && (ball.x - ball.r < plane.x + plane.width)
                && (ball.y + ball.r > plane.y) && (ball.y - ball.r < plane.y + plane.height)) {
                
                return true;
            };
        }
        return false;
    }

    function readControls() {
        if (rightPressed) {
            plane.rotation = (plane.rotation + 2) % 360;
        }
        if  (leftPressed) {
            plane.rotation = (plane.rotation - 2) % 360;;
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        advancePlane();
        advanceBullets();
        if (checkCollision()) {
            plane.color = plane.color == "#0000FF" ? "#00FF00" : "#0000FF";
        }
        readControls();
        drawPlane();
        drawBullets();
    }

    function initControls() {
        gInput = document.getElementById("gForce");
        gInput.addEventListener("change", function() {
            g = [0, parseFloat(gInput.value) / 100];
        });
        wInput = document.getElementById("wForce");
        wInput.addEventListener("change", function() {
            wForce = [0, parseFloat(wInput.value) / 100];
        });
        eInput = document.getElementById("eForce");
        eInput.addEventListener("change", function() {
            eForce = parseFloat(eInput.value) / 100;
        });
        mass = document.getElementById("mass");
        mass.addEventListener("change", function() {
            m = parseFloat(mass.value) / 100;
        });
        maxInput = document.getElementById("maxSpeed");
        maxInput.addEventListener("change", function() {
            maxSpeed = parseFloat(maxInput.value) / 100;
        });
    }

    function init() {
        planeImage = new Image();
        planeImage.src = 'red3.png';
        planeImage.onload = function() {
            plane.image = planeImage;
        }
    }

    init();
    setInterval(draw, 10);
    initControls();
    

    // 1. direction move of plane
    // 2. fast/slow
    // 3. shoot bullets
    // 4. autopilot
    // 5. eject
    // 6. house
    // 7. collision detection of rotated object
</script>

</body>
</html>